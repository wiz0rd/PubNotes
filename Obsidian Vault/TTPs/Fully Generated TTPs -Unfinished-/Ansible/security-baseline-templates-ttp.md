# Security Baseline Templates TTP

## Goal
The goal of this TTP is to create and implement security baseline templates using Ansible. These templates will contain standardized security configurations that can be applied consistently across various network devices to ensure a uniform security posture.

## Overview
This TTP covers the process of creating security baseline templates, applying them to multiple platforms, and ensuring compliance across the network using Ansible.

![Security Baseline Workflow](https://example.com/path/to/security_baseline_workflow.png)
*Figure 1: Security Baseline Workflow. Replace with an actual diagram showing the process of creating and applying security baselines.*

## Prerequisites
- Ansible installed and configured
- Basic understanding of network security principles
- Access to network devices (with appropriate credentials)
- Familiarity with Jinja2 templating

## Step-by-step Guide

### 1. Define Security Baseline Requirements

Create a document outlining your organization's security requirements. Common items include:

- Password policies
- Access control lists (ACLs)
- SNMP configurations
- NTP settings
- Logging configurations
- SSH/TELNET access restrictions

### 2. Create Jinja2 Templates

Create a directory for your templates:

```bash
mkdir templates
cd templates
```

Create a template file `security_baseline.j2`:

```jinja2
# Security Baseline Configuration
# Generated by Ansible on {{ ansible_date_time.date }}

# Password Policy
enable secret {{ enable_secret }}
service password-encryption

# Access Control Lists
{% for acl in access_lists %}
access-list {{ acl.number }} {{ acl.action }} {{ acl.protocol }} {{ acl.source }} {{ acl.destination }}
{% endfor %}

# SNMP Configuration
snmp-server community {{ snmp_community }} RO
snmp-server location {{ snmp_location }}
snmp-server contact {{ snmp_contact }}

# NTP Configuration
{% for server in ntp_servers %}
ntp server {{ server }}
{% endfor %}

# Logging Configuration
logging console critical
logging buffered informational
{% for host in syslog_servers %}
logging host {{ host }}
{% endfor %}

# SSH Configuration
ip ssh version 2
ip ssh authentication-retries 3
ip ssh time-out 60

# Disable Unused Services
no ip http server
no ip http secure-server
no service finger
```

### 3. Create Variable Files

Create a `group_vars` directory and add a file for your network devices:

```bash
mkdir group_vars
touch group_vars/network_devices.yml
```

Add the following content to `network_devices.yml`:

```yaml
---
enable_secret: "{{ vault_enable_secret }}"
access_lists:
  - number: 100
    action: deny
    protocol: ip
    source: any
    destination: any
snmp_community: "{{ vault_snmp_community }}"
snmp_location: "Data Center 1"
snmp_contact: "admin@example.com"
ntp_servers:
  - 10.0.0.1
  - 10.0.0.2
syslog_servers:
  - 10.0.0.3
  - 10.0.0.4
```

### 4. Create an Ansible Vault

Create an encrypted file to store sensitive data:

```bash
ansible-vault create group_vars/vault.yml
```

Add the following content:

```yaml
vault_enable_secret: your_secure_enable_secret
vault_snmp_community: your_secure_snmp_community
```

### 5. Create the Security Baseline Playbook

Create a file named `apply_security_baseline.yml`:

```yaml
---
- name: Apply Security Baseline
  hosts: all
  gather_facts: no

  tasks:
    - name: Generate security baseline configuration
      template:
        src: templates/security_baseline.j2
        dest: "{{ ansible_user_dir }}/{{ inventory_hostname }}_security_baseline.cfg"
      delegate_to: localhost

    - name: Apply security baseline configuration
      ios_config:
        src: "{{ ansible_user_dir }}/{{ inventory_hostname }}_security_baseline.cfg"
      register: config_result

    - name: Save configuration if changed
      ios_command:
        commands: write memory
      when: config_result.changed

    - name: Remove temporary configuration file
      file:
        path: "{{ ansible_user_dir }}/{{ inventory_hostname }}_security_baseline.cfg"
        state: absent
      delegate_to: localhost

    - name: Verify configuration
      ios_command:
        commands:
          - show run | include enable secret
          - show run | include access-list
          - show run | include snmp-server
          - show run | include ntp server
          - show run | include logging
      register: verify_output

    - name: Display verification results
      debug:
        var: verify_output.stdout_lines
```

### 6. Create an Inventory File

Create an inventory file `network_inventory.yml`:

```yaml
all:
  children:
    routers:
      hosts:
        router1:
          ansible_host: 192.168.1.1
        router2:
          ansible_host: 192.168.1.2
    switches:
      hosts:
        switch1:
          ansible_host: 192.168.1.101
        switch2:
          ansible_host: 192.168.1.102
  vars:
    ansible_network_os: ios
    ansible_connection: network_cli
    ansible_user: admin
    ansible_password: "{{ vault_ansible_password }}"
```

### 7. Run the Playbook

Execute the playbook:

```bash
ansible-playbook -i network_inventory.yml apply_security_baseline.yml --ask-vault-pass
```

### 8. Implement Compliance Checking

Create a compliance checking playbook `check_security_compliance.yml`:

```yaml
---
- name: Check Security Compliance
  hosts: all
  gather_facts: no

  tasks:
    - name: Collect device configurations
      ios_command:
        commands:
          - show run
      register: config_output

    - name: Check password policy
      assert:
        that:
          - "'enable secret' in config_output.stdout[0]"
          - "'service password-encryption' in config_output.stdout[0]"
        fail_msg: "Password policy not compliant"

    - name: Check SNMP configuration
      assert:
        that:
          - "'snmp-server community' in config_output.stdout[0]"
          - "'snmp-server location' in config_output.stdout[0]"
          - "'snmp-server contact' in config_output.stdout[0]"
        fail_msg: "SNMP configuration not compliant"

    # Add more compliance checks as needed

    - name: Generate compliance report
      template:
        src: templates/compliance_report.j2
        dest: "reports/{{ inventory_hostname }}_compliance_report.txt"
      delegate_to: localhost
```

### 9. Schedule Regular Compliance Checks

Add a cron job to run the compliance check regularly:

```bash
crontab -e
```

Add the following line:

```
0 2 * * * /usr/bin/ansible-playbook /path/to/check_security_compliance.yml
```

### 10. Implement Version Control for Templates

Initialize a Git repository for your Ansible project:

```bash
git init
git add .
git commit -m "Initial commit of security baseline templates"
```

## Advanced Topics
- Implementing role-based templates for different device types
- Integrating with a configuration management database (CMDB)
- Automating remediation of non-compliant devices
- Implementing a change management workflow for template updates

## Troubleshooting
- Verify device connectivity and credentials if playbook fails
- Check Ansible logs for detailed error messages
- Use `--check` mode to test playbooks without making changes
- Verify template syntax using `ansible-playbook --syntax-check`

## Best Practices
1. Regularly review and update security baseline templates
2. Test templates in a lab environment before applying to production
3. Implement change control procedures for template modifications
4. Document all customizations and exceptions to the baseline
5. Regularly audit devices for compliance with the security baseline
6. Use version control for all templates and playbooks
7. Implement a peer review process for template changes

## Additional Resources
- [Ansible Network Automation Documentation](https://docs.ansible.com/ansible/latest/network/index.html)
- [CIS Benchmarks for Network Devices](https://www.cisecurity.org/benchmark/networking_devices)
- [NIST Cybersecurity Framework](https://www.nist.gov/cyberframework)

## Glossary
- **Baseline**: A minimum level of security that should be applied to all systems
- **Jinja2**: A modern and designer-friendly templating language for Python
- **Idempotency**: The property of certain operations in computer science whereby they can be applied multiple times without changing the result beyond the initial application
- **Compliance**: The state of meeting rules, standards, or laws
- **Remediation**: The act of correcting a vulnerability or non-compliant state

